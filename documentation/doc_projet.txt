"""
ğŸ“Œ Contexte du projet
Backend Django REST Framework (DRF) pour une application de pÃ¢tisserie.
Lâ€™objectif est de gÃ©rer les recettes, les ingrÃ©dients, leurs prix, les moules, 
et de calculer les coÃ»ts et quantitÃ©s nÃ©cessaires en fonction des portions ou des moules utilisÃ©s.

âœ… FonctionnalitÃ©s principales :
    - Gestion des ingrÃ©dients avec leurs catÃ©gories et labels.
    - Gestion des recettes, y compris les sous-recettes et les Ã©tapes (+ possibilitÃ© de dupliquer une recette ; + archivage ; + favoris ; + Adaptation intelligente ("fork")).
    - Recherche de recette par catÃ©gorie, par label, par prix, par ingrÃ©dient, par temps de prÃ©paration, etc.
    - Gestion des moules (pans) avec calcul automatique de volumes pour ajuster les quantitÃ©s.
    - Calcul automatique des quantitÃ©s en fonction des servings, du moule utilisÃ©, d'une recette de rÃ©fÃ©rence, ou de quantitÃ©s spÃ©cifiques d'un ou plusieurs ingrÃ©dient.
    - Calcul automatique du coÃ»t dâ€™une recette en fonction du prix des ingrÃ©dients (option : en fonction de quel magasin peuvent provenir les ingrÃ©dients).
    - PossibilitÃ© d'application collaborative pour remplir la base de donnÃ©es (le prix des ingrÃ©dients de diffÃ©rentes marques et dans les diffÃ©rents magasins).
    - Gestion de compte utilisateur et compte premium.
    - Tests automatisÃ©s (modÃ¨les, validation, API CRUD et services) avec pytest.

ğŸ“‚ Architecture du projet
1. Applications Django
    - pastry_app/ (application principale) Contient toute la logique mÃ©tier de lâ€™application.
    - enchante/ (paramÃ¨tres du projet) Contient la configuration globale du projet (settings.py, urls.py, wsgi.py).

2 Principaux fichiers Django
Fichier	RÃ´le
    models.py	    DÃ©finition des modÃ¨les : Ingredient, Recipe, Pan, Category, Labelâ€¦
    serializers.py	SÃ©rialisation des donnÃ©es pour Django REST Framework
    views.py	    Logique mÃ©tier et endpoints API
    urls.py	        Routes de l'API
    admin.py	    Configuration de lâ€™interface dâ€™administration Django
    mixins.py	    Mixins de vues gÃ©nÃ©riques rÃ©utilisables
    permissions.py	Classes de permissions personnalisÃ©es pour DRF
    constants.py	Variables constantes utilisÃ©es dans lâ€™application
    utils.py	    Fonctions utilitaires et calculs dâ€™adaptation
    tests/	        Dossier contenant tous les tests (modÃ¨le, validation, API/CRUD, services)
    static/	        Fichiers CSS & JS pour le mode admin
    settings.py	    Configuration principale de Django

ğŸ“Š ModÃ¨les principaux
    1. Ingredient (IngrÃ©dients) - Stocke les ingrÃ©dients et leurs catÃ©gories / labels associÃ©s.
        Nom unique (ingredient_name)
        CatÃ©gories (ManyToMany â†’ Category)
        Labels (ManyToMany â†’ Label)
        RÃ©fÃ©rences dâ€™unitÃ© (ingredient_unit_references) â†’ permet le calcul par poids unitaire
    2. Category (CatÃ©gories dâ€™ingrÃ©dients et de recettes) - Classement des ingrÃ©dients et des recettes.
        category_name : Nom unique de la catÃ©gorie.
        category_type : recette, ingrÃ©dient ou both
        Relation ManyToMany avec Ingredient et Recipe (un ingrÃ©dient ou une recette peut avoir plusieurs catÃ©gories).
        Relation hiÃ©rarchique (parent_category)
    3. Label (Labels alimentaires et certifications) - Classement par label (ex: Bio, Vegan, AOC, etc.).
        label_name : Nom unique du label.
        Relation ManyToMany avec Ingredient et Recipe (un ingrÃ©dient ou une recette peut avoir plusieurs labels).
    4. Pan (Moules) - GÃ¨re les diffÃ©rents types de moules avec calcul de volume
        pan_name : Nom unique du moule
        pan_type : Type (round, square, custom)
        Dimensions + volume prÃ©-calculÃ© (volume_cm3_cache)
    5. Recipe (Recettes) - Stocke les informations principales dâ€™une recette
        recipe_name : Nom unique de la recette
        ingredients : Relation avec Ingredient
        Chef (chef_name)
        Moule associÃ© (pan)
        Portions (servings_min, servings_max)
        Poids total (total_recipe_quantity)
        CatÃ©gories / labels
        Gestion de la visibilitÃ© et propriÃ©tÃ© (user/guest_id)
        Relation vers recettes parentes (forks, variations)
    6. RecipeIngredient (Association recette - ingrÃ©dients) - Associe des ingrÃ©dients Ã  une recette avec une quantitÃ© donnÃ©e.
        recipe : ForeignKey vers Recipe.
        ingredient : ForeignKey vers Ingredient.
        quantity : QuantitÃ© de lâ€™ingrÃ©dient requise pour cette recette.
        unit : UnitÃ© de mesure utilisÃ©e (grammes, litres, etc.).
    7. RecipeStep (Ã‰tapes de la recette) - Stocke chaque Ã©tape de prÃ©paration dâ€™une recette.
        recipe : ForeignKey vers Recipe.
        step_number : NumÃ©ro de lâ€™Ã©tape (permet de garder lâ€™ordre).
        description : DÃ©tail de lâ€™Ã©tape de prÃ©paration.
    8. SubRecipe (Recette dans une autre recette) - GÃ¨re les recettes qui sont des sous-recettes dâ€™une autre recette.
        main_recipe : ForeignKey vers la recette principale.
        sub_recipe : ForeignKey vers une autre Recipe (qui est une sous-recette).
        quantity : QuantitÃ© de la sous-recette utilisÃ©e dans la recette principale.
    9. IngredientPrice (Prix des ingrÃ©dients par magasin) - Stocke le prix des ingrÃ©dients selon le magasin.
        ingredient : ForeignKey vers Ingredient (chaque prix est liÃ© Ã  un ingrÃ©dient prÃ©cis).
        store : Nom du magasin oÃ¹ le prix est applicable.
        price : Prix de lâ€™ingrÃ©dient dans ce magasin.
    10. IngredientUnitReference
        Lien vers un Ingredient
        Nom dâ€™unitÃ© standardisÃ©e (unit)
        Poids unitaire en grammes (unit_weight_g)

ğŸ“ FonctionnalitÃ©s avancÃ©es : Adaptation, Estimation et Suggestion
Le backend intÃ¨gre une logique mÃ©tier avancÃ©e autour de lâ€™adaptation des recettes, la suggestion de moules et lâ€™estimation des portions ou volumes.
Use cases supportÃ©s :

Adapter une recette vers un autre moule (Pan â†’ Pan)
â Ajuste les quantitÃ©s dâ€™une recette en fonction dâ€™un moule source et dâ€™un moule cible.

Adapter une recette en fonction dâ€™un nombre de portions vers un moule (Serving â†’ Pan)
â Lâ€™utilisateur prÃ©cise le nombre de portions souhaitÃ© et le moule cible.

Adapter une recette dâ€™un nombre de portions vers un autre (Serving â†’ Serving)
â Permet de recalculer les quantitÃ©s sans dÃ©pendre dâ€™un moule.

Adapter une recette en fonction d'une recette de rÃ©fÃ©rence 
â Permet d'adapter la recette en se basant sur une recette de rÃ©fÃ©rence vers le moule cible ou vers le nombre de portions souhaitÃ©.

Estimer combien de portions une recette donne dans un moule donnÃ© (Pan â†’ Serving)
â Fournit lâ€™intervalle de portions rÃ©alisables avec la recette dans un moule spÃ©cifique.

Estimer le nombre de portions rÃ©alisables avec un moule sans passer par une recette (Pan seul)
â Fournit le volume et un intervalle de portions pour un moule existant ou dÃ©fini par ses dimensions.

SuggÃ©rer les moules adaptÃ©s pour un nombre de portions (Serving seul)
â Lâ€™utilisateur fournit le nombre de portions souhaitÃ©es et obtient une liste de moules compatibles.

SuggÃ©rer des recettes de rÃ©fÃ©rence pertinentes
â A partir d'une recette, est proposÃ© Ã  l'utilisateur une liste de recette de rÃ©fÃ©rences 'similaires' avec la prioritÃ© suivante : 
    1. mÃªme sous-catÃ©gorie
    2. MÃªme catÃ©gorie
    3. Autre recette compatible

Si plusieurs modes dâ€™adaptation sont possibles dans une requÃªte, le backend applique une prioritÃ© stricte :
Pan â†’ Pan (prioritaire si source_pan et target_pan sont fournis)
Sinon Serving â†’ Pan
Sinon Serving â†’ Serving
Sinon Pan â†’ Serving

ğŸ”§ Endpoints API associÃ©s :
/api/recipes-adapt/	         â Endpoint central pour les cas 1 Ã  4
/api/pans/estimate-volume/   â Estimation volume + portions Ã  partir dâ€™un moule (cas 5)
/api/pans/suggest/	         â Suggestion de moules selon un nombre de portions (cas 6)


ğŸ“Œ Tests mis en place
Organisation des tests :

tests/
â”‚â”€â”€ models/  â†’ Tests des modÃ¨les (`test_category_model.py`, `test_ingredient_model.py`, etc.)
â”‚â”€â”€ validation/  â†’ Tests de validation mÃ©tier (`test_category_validation.py`, `test_recipe_validation.py`, etc.)
â”‚â”€â”€ crud/  â†’ Tests CRUD via API (`test_category.py`, `test_ingredient.py`, etc.)
â”‚â”€â”€ base_api_test.py  â†’ Classe `BaseAPITest` pour factoriser les tests API
|â”€â”€ services/  â†’ Tests des services d'adaptation, d'estimation et de suggestion de moules et servings et de recette de rÃ©fÃ©rence.


ğŸ“ FonctionnalitÃ©s avancÃ©esâ€¯: Adaptation, Forks, VisibilitÃ© & Gestion utilisateurs/invitÃ©s

Lâ€™application permetâ€¯:

- Lâ€™adaptation intelligente (â€œforkâ€)â€¯: chaque utilisateur (ou invitÃ©) peut crÃ©er une adaptation personnalisÃ©e dâ€™une recette existante 
(par exemple, ajuster pour un autre moule, modifier des ingrÃ©dients ou les quantitÃ©s).
    - Lâ€™adaptation crÃ©e un nouvel objet Recipe liÃ© Ã  la recette mÃ¨re (parent_recipe, recipe_type="VARIATION").
    - Les objets â€œadaptÃ©sâ€ sont visibles, modifiables et supprimables uniquement par leur crÃ©ateur (user ou guest_id).
    - Les recettes de base ou publiques restent inaltÃ©rÃ©es et non dupliquÃ©es.

- La gestion fluide des invitÃ©s (â€œguestâ€)â€¯: un invitÃ© (utilisateur sans compte) possÃ¨de un identifiant unique cÃ´tÃ© front (guest_id) 
pour retrouver ses objets (recettes, ingrÃ©dients, etc.).

- Le masquage logique (soft-hide)â€¯: suppression dâ€™une recette de base = masquage uniquement pour le user/guest, sans suppression rÃ©elle en base. 
Les autres utilisateurs continuent Ã  voir lâ€™objet.

- ContrÃ´le strict des droitsâ€¯: les permissions API empÃªchent toute modification/suppression dâ€™un objet â€œde baseâ€ ou public par un non-propriÃ©taire. 
Les objets privÃ©s restent visibles exclusivement pour leur crÃ©ateur.

# Exemple dâ€™usage cÃ´tÃ© frontâ€¯:

- Lorsquâ€™un invitÃ© ou utilisateur adapte (â€œforkâ€) une recette, il obtient sa propre version, indÃ©pendante, sans polluer la base commune.
- Un bouton â€œmasquer cette recette de baseâ€ ne la supprime pasâ€¯: elle est juste cachÃ©e Ã  lâ€™utilisateur concernÃ©.
- Toute requÃªte de modification/suppression sur un objet de base est refusÃ©e (statut 403).

Objectifâ€¯:
Favoriser lâ€™adaptabilitÃ© et la personnalisation, tout en Ã©vitant la duplication de donnÃ©es, en respectant les droits de chaque utilisateur 
et en gardant une UX cohÃ©rente mÃªme pour les invitÃ©s.

"""